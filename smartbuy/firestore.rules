rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function signedIn() {
      return request.auth != null;
    }

    // For LIST documents only (can use resource)
    function isOwnerOrMemberList() {
      return signedIn()
        && (
          resource.data.ownerId == request.auth.uid ||
          (resource.data.members != null &&
           request.auth.uid in resource.data.members)
        );
    }

    // For child collections under lists/{listId}
    function isOwnerOrMemberFromList(listId) {
      let list = get(/databases/$(database)/documents/lists/$(listId)).data;
      return signedIn()
        && (
          list.ownerId == request.auth.uid ||
          (list.members != null &&
           request.auth.uid in list.members)
        );
    }

    // ======================================
    // USERS COLLECTION
    // ======================================
    match /users/{userId} {
      allow create: if signedIn();
      allow read, update, delete: if signedIn() && request.auth.uid == userId;
    }

    // ======================================
    // USER SETTINGS
    // /userSettings/{userId}
    // ======================================
    match /userSettings/{userId} {
      allow read, write: if signedIn() && request.auth.uid == userId;
    }

    // ======================================
    // NOTIFICATIONS
    // /notifications/{userId}/{notificationId}
    // ======================================
    match /notifications/{userId}/{notificationId} {
      allow read, delete: if signedIn() && request.auth.uid == userId;
      allow create: if signedIn() && request.auth.uid == userId;
      allow update: if false; // notifications cannot be modified after creation
    }

    // ======================================
    // DEVICE PUSH TOKENS
    // /pushTokens/{userId}
    // ======================================
    match /pushTokens/{userId} {
      allow read, write, delete: if signedIn() && request.auth.uid == userId;
    }

    // ======================================
    // LISTS
    // /lists/{listId}
    // ======================================
    match /lists/{listId} {

      // create requires signed-in user
      allow create: if signedIn();

      // read/update/delete requires ownership or membership
      allow read, update, delete: if isOwnerOrMemberList();

      // ===========================
      // ITEMS inside a list
      // ===========================
      match /items/{itemId} {
        allow read, write: if isOwnerOrMemberFromList(listId);
      }

      // ===========================
      // REMINDERS inside a list
      // /lists/{listId}/reminders/{reminderId}
      // ===========================
      match /reminders/{reminderId} {
        allow read, write: if isOwnerOrMemberFromList(listId);
      }

      // ===========================
      // PRICE ALERTS inside a list
      // /lists/{listId}/priceAlerts/{alertId}
      // ===========================
      match /priceAlerts/{alertId} {
        allow read, write: if isOwnerOrMemberFromList(listId);
      }

      // ===========================
      // BUDGET
      // /lists/{listId}/budget/{docId}
      // ===========================
      match /budget/{docId} {
        allow read, write: if isOwnerOrMemberFromList(listId);
      }
    }

    // ======================================
    // INVITES
    // /invites/{inviteId}
    // ======================================
    match /invites/{inviteId} {

      function isReceiver() {
        return resource.data.receiverId == request.auth.uid;
      }
      function isSender() {
        return resource.data.senderId == request.auth.uid;
      }

      // Anybody signed in may create an invite
      allow create: if signedIn();

      // Only the involved users may read
      allow read: if signedIn() && (isSender() || isReceiver());

      // Update (accept/reject)
      allow update: if signedIn() && isReceiver()
        && request.time < resource.data.expiresAt // cannot accept expired
        && request.resource.data.token == resource.data.token; // token cannot be modified

      // DELETE: both sender & receiver can delete
      allow delete: if signedIn() && (isSender() || isReceiver());
    }

    // ANALYTICS
    // /analytics/{userId}
    // ======================================
    // The user must only access his own analytics
    match /analytics/{userId}/{path=**} {
        allow read, write: if signedIn() && request.auth.uid == userId;
    }
   // ======================================
    // PANTRY
    // /pantry/{userId}/items/{itemId}
    // ======================================
    match /pantry/{userId}/items/{itemId} {

      // ensure user signed in and accessing own pantry
      allow read, write: if signedIn() && request.auth.uid == userId;

      // Validate fields â€” prevent malformed or malicious data
      allow update: if signedIn() && request.auth.uid == userId
        && request.resource.data.keys().hasOnly([
          "item",
          "quantity",
          "unit",
          "lastUpdated",
          "estimatedConsumptionRateDays",
          "expiresAt",
          "lowStockThreshold"
        ])
        && request.resource.data.quantity is int
        && request.resource.data.quantity >= 0
        && request.resource.data.lowStockThreshold is int
        && request.resource.data.lowStockThreshold >= 0;
    }
  }
}
